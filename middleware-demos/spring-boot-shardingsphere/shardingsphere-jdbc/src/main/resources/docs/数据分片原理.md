## 一、数据分片概述

### 1.1 背景

随着数据量的快速增长，传统将数据集中存储在**单一节点**的方案在性能、可用性和运维成本方面已经难以满足现代海量数据场景的需求。

从性能方面来说，查询性能和高并发都受到影响。

- **B+ 树索引问题**：关系型数据库大多使用 B+ 树类型的索引。当数据量超过一定阈值时，索引深度增加，磁盘 I/O 次数随之增多，导致查询性能下降。
- **高并发瓶颈**：面对高并发请求，单一数据库节点成为系统的性能瓶颈。

从可用性的方面来讲，

- **无状态服务**：现代系统普遍采用服务化和无状态架构，可轻松扩容。但这导致所有压力集中在数据库上。
- **单点问题**：传统的单节点或简单的主从架构已经难以承载这种压力，数据库的可用性已成为整个系统的关键。

从运维成本方面考虑，

- **数据阈值压力**：当数据量超过阈值（通常为 1TB），DBA 的运维压力显著增加。数据备份和恢复的时间成本也随数据量增加而不可控。



### 1.2 什么是数据分片

数据分片指<font color="blue">**按照某个维度将存放在单一数据库中的数据分散地存放至多个数据库或表中**以达到提升性能瓶颈以及可用性的效果</font>。数据分片的有效手段是对关系型数据库进行分库和分表。分库和分表均可以有效的避免由数据量超过可承受阈值而产生的查询瓶颈。

- 分库：有效的**分散对数据库单点的访问量**，更加适合高并发。
- 分表：虽然无法缓解数据库压力，但却能够提供尽量将分布式事务转化为本地事务的可能，从而降低复杂度。将数据拆分到多个表中，避免单表数据量过大带来的查询瓶颈





### 1.3 应用场景

- 海量数据高并发的 OLTP 场景
- 海量数据实时分析 OLAP 场景



## 二、数据分片的拆分方式

数据分片的方式主要分为**垂直分片**和**水平分片**。

### 2.1 垂直分片

按照<font color="blue">**业务拆分**</font>的方式称为垂直分片，又称为纵向拆分，它的核心理念是专库专用。 在拆分之前，一个数据库由多个数据表构成，每个表对应着不同的业务。而拆分之后，则是按照业务**将表进行归类，分布到不同的数据库中**，从而将压力分散至不同的数据库。

 下图展示了根据业务需要，将用户表和订单表垂直分片到不同的数据库的方案。

<img src="images/vertical_sharding.png" alt="垂直分片" style="zoom:80%;" />



垂直拆分可以缓解数据量和访问量带来的问题，但**无法真正地解决单点瓶颈问题**。如果垂直拆分之后，表中的数据量依然超过单节点所能承载的阈值，则需要水平分片来进一步处理。



### 2.2 水平分片

水平分片**通过某个字段（或某几个字段），根据某种规则将数据分散至多个库或表中**，每个分片仅包含数据的一部分。

<img src="images/horizontal_sharding.png" alt="水平分片" style="zoom:80%;" />

水平分片从理论上突破了单机数据量处理的瓶颈，并且扩展相对自由，是数据分片的标准解决方案。



### 2.3 水平分片和垂直分片的区别

| 区别         | 垂直分片（Vertical Sharding）                | 水平分片（Horizontal Sharding）                        |
| ------------ | -------------------------------------------- | ------------------------------------------------------ |
| **定义**     | 按功能模块或业务领域将数据表拆分成多个数据库 | 按数据行进行切分，将同一表的数据按字段拆分到多个数据库 |
| **分片依据** | 以表为单位，根据业务模块划分                 | 以行为单位，根据字段和规则进行水平切分                 |
| **扩展性**   | 适合垂直扩展，业务模块可以独立扩展           | 适合水平扩展，可以动态增加分片                         |
| **优势**     | 业务模块隔离，减少表间关联查询               | 分散数据负载，减轻单表压力，提高查询性能               |
| **劣势**     | 需要调整业务架构，跨模块查询变得复杂         | 跨分片查询和事务处理复杂，需要分布式事务管理           |
| **维护成本** | 中等，需调整表结构及业务逻辑                 | 较高，涉及分片规则调整和分布式事务管理                 |



## 三、数据分片引起的挑战

数据分区在提升性能和可扩展性的同时，也可能引发一些问题和挑战。

### 3.1 跨库事务

跨库事务也是分布式的数据库集群要面对的棘手事情。通常而言，跨分区查询可能变得复杂且性能较低，我们应该尽量避免跨库事务并使用本地事务。

避免跨库事务的方案：

- **同库不同表**：善于使用**同库不同表**可有效避免分布式事务带来的麻烦。例如，将用户数据和订单数据分散在同一个数据库的不同表中，可以减少下单操作时的事务复杂度。
- **数据复制**：如果业务场景经常需要查询最近 1 年的数据，可以维护一个单独的表 `recent_orders`，只存储最近一年的订单数据，以减少跨分区操作。



### 3.2 事务一致性

在不能避免跨库事务的场景，有些业务仍然需要保持事务的一致性。 而基于 XA 的分布式事务由于在并发度高的场景中性能无法满足需要，并未被互联网巨头大规模使用，他们大多采用最终一致性的柔性事务代替强一致事务。



### 3.3 数据一致性

在分区间保持数据一致性变得困难，尤其是跨分区事务。我们应使用分布式事务协议（如两阶段提交），或设计应用程序以尽量避免跨分区事务。



## 四、使用过程中的注意事项

### 4.1 读请求扩散

**读请求扩散**：在分库分表的场景下，如果在查询时没有带上**分片键**，系统无法直接确定数据所在的具体数据库或表。为了解决这一问题，系统只能在**所有的数据库和表中扫描**以查找数据，降低了性能。

举个例子，由于登录时只使用了手机号或者邮箱，没有带用户名（分片键），导致无法确定用户的分片键，使得系统无法直接锁定用户的数据位于哪个数据库或者哪张表中。为了找到用户的数据，只能对全部的数据库和表进行扫描查询。为了解决这个问题，我们引入了两张**路由表**：用户手机号表和用户邮箱表。这些表的核心字段是手机号和邮箱，以及它们对应的用户名。通过这样的设计，我们能够在用户登录时，灵活地使用手机号、邮箱或用户名来进行认证。







## 参考资料

[数据分片 :: ShardingSphere](https://shardingsphere.apache.org/document/current/cn/features/sharding/)