## 三、分片算法

分片算法就是水平分片中的划分规则。

### 2.1 范围分区

- **定义**：根据某个列(分片键)的值范围将数据分成不同的分区。
- **示例**：假设有一个销售记录表，可以按照销售日期将数据分区，每个月的数据放在一个分区中。
- **优点：**能够对用来进行范围分区的关键字执行范围查询
- **缺点：**可能产生数据分布不均或请求流量不均的问题
- **案例：**使用范围分区的分布式存储系统有 Goog Bigtable、Apache HBase2、PingCAP TiKV

### 2.2 哈希分区

- **定义**：使用哈希函数对某个列(分片键)的值进行哈希运算，将结果映射到不同的分区。
- **示例**：假设有一个订单表，可以对订单ID进行哈希运算，根据哈希值将数据分区。
- **优点**：数据分布相对均匀，能够在一定程度上避免热点问题。
- **缺点：**在不额外存储数据的情况下，无法执行范围查询。
- **案例：**使用一致性哈希的典型的分布式数据存储系统有 Dyamo 和 Apache Cassandra

> 在增加或者删除分布式系统中的节点时，普通的哈希分区算法无法避免大规模数据移动问题。但是，[一致性哈希分区算法](https://developer.aliyun.com/article/1082388)可以避免这一问题。





## 基因法

基因法的核心思想是根据多个字段（如用户ID、订单ID等）生成一个编码，决定数据应该存储到哪个表中。

例如，假设有这么一个场景，让同一个用户的所有订单存储到一个表中，并且能够通过用户ID或订单ID进行精准查询。这里，我们可以利用基因法，通过用户ID和订单ID的组合生成一个唯一的标识符，并将该标识符映射到指定的表中。





分库分表可能使用的算法：

- 基因法
- 订单号生成：为了保证订单号生成递增，我们参考雪花算法自定义了一个 `DistributedIdGenerator`，生成后的分布式 ID 再拼接上用户的后六位。



自定义分片算法： [手摸手之订单如何分库分表 (yuque.com)](https://www.yuque.com/magestack/12306/dyr1d4r3me19gg7l#wECos)





## 如何选择用户分片键

[手摸手之用户如何实现分库分表 (yuque.com)](https://www.yuque.com/magestack/12306/pb98neetmww1rr9y#oSTEl)

选择分库分表中的分片键（Sharding Key）是一个关键决策，它直接影响了分库分表的性能和可扩展性。以下是一些选择分片键的关键因素：

1. 访问频率：选择分片键应考虑数据的访问频率。将经常访问的数据放在同一个分片上，可以提高查询性能和降低跨分片查询的开销。
2. 数据均匀性：分片键应该保证数据的均匀分布在各个分片上，避免出现热点数据集中在某个分片上的情况。
3. 业务关联性：分片键应该与业务关联紧密，这样可以避免跨分片查询和跨库事务的复杂性。
4. 数据不可变：一旦选择了分片键，它应该是不可变的，不能随着业务的变化而频繁修改。

基于以上考虑，我们选择使用 username 作为分片键。







